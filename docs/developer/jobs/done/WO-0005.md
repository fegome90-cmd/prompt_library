# WO-0005: Agregar validaci칩n Zod a DTOs de API

## Metadatos
| Campo | Valor |
|-------|-------|
| id | WO-0005 |
| title | Agregar validaci칩n Zod a DTOs de API |
| type | security |
| priority | P1 |
| area | BE |
| status | 游댮 Pending |

## Rationale
Hallazgo MED: Sin validaci칩n de input. Body desestructurado sin validaci칩n permite cualquier input, riesgo de inyecci칩n y datos corruptos.

## Scope

### Include
- `src/lib/validators/prompt.ts` (crear)
- `src/app/api/prompts/route.ts`
- `src/app/api/prompts/[id]/route.ts`

### Exclude
- No modificar endpoints de feedback ni publish
- No cambiar estructura de respuesta

## Dependencies
Ninguna

## Acceptance Criteria
- [ ] POST /api/prompts valida body con Zod antes de crear
- [ ] PUT /api/prompts/[id] valida body con Zod antes de actualizar
- [ ] Request con datos inv치lidos retorna 400 con mensaje descriptivo
- [ ] Request con datos v치lidos funciona normalmente

## Definition of Done

### Tests
- [ ] curl con title vac칤o retorna 400
- [ ] curl con body vac칤o retorna 400

### Security
- [ ] Input sanitizado antes de llegar a DB

### Observability
- [ ] console.warn con campos inv치lidos cuando validaci칩n falla

### Docs
- [ ] Comentarios en validator explicando restricciones

### Evidence
- [ ] curl commands mostrando 400 para datos inv치lidos
- [ ] Diff del cambio

## Verify

### Commands
```bash
# Test body vac칤o
curl -X POST -H "Content-Type: application/json" -d '{}' http://localhost:3000/api/prompts

# Test campos vac칤os
curl -X POST -H "Content-Type: application/json" -d '{"title":"","body":"","category":""}' http://localhost:3000/api/prompts

# Lint
bun run lint
```

### Expected
- Primer comando retorna 400 con errores de campos requeridos
- Segundo comando retorna 400 con errores de validaci칩n
- Lint pasa

## Risk

### Failure Modes
- Validaci칩n muy restrictiva bloquea casos leg칤timos
- Mensajes de error poco claros

### Rollback
```bash
git revert <commit-hash>
```

## Notes
- Schemas m칤nimos: title (string, min 1, max 200), body (string, min 1), category (string, min 1)
- Instalar zod: `bun add zod`

## Implementaci칩n Sugerida

```typescript
// src/lib/validators/prompt.ts
import { z } from 'zod';

export const createPromptSchema = z.object({
  title: z.string().min(1, 'T칤tulo requerido').max(200, 'M치ximo 200 caracteres'),
  description: z.string().max(500).optional(),
  body: z.string().min(1, 'Cuerpo del prompt requerido'),
  category: z.string().min(1, 'Categor칤a requerida'),
  tags: z.array(z.string()).optional().default([]),
  variablesSchema: z.array(z.any()).optional().default([]),
  riskLevel: z.enum(['low', 'medium', 'high']).optional().default('low'),
});

export const updatePromptSchema = createPromptSchema.partial();

// En route.ts
import { createPromptSchema } from '@/lib/validators/prompt';

export async function POST(request: NextRequest) {
  try {
    const body = await request.json();
    
    // Validaci칩n
    const validated = createPromptSchema.safeParse(body);
    if (!validated.success) {
      return NextResponse.json(
        { error: 'Datos inv치lidos', details: validated.error.flatten() },
        { status: 400 }
      );
    }
    
    const { title, description, body: promptBody, ... } = validated.data;
    // Continuar con creaci칩n...
  }
}
```

## Log de Cambios
| Fecha | Estado | Notas |
|-------|--------|-------|
| - | 游댮 Pending | Creado |
