# WO-0003: Validar reviewer existe antes de crear auditLog

## Metadatos
| Campo | Valor |
|-------|-------|
| id | WO-0003 |
| title | Validar reviewer existe antes de crear auditLog |
| type | fix |
| priority | P0 |
| area | BE |
| status |  Pending |

## Rationale
Hallazgo MED: En publish/route.ts, si no hay defaultUser, reviewer es null y auditLog.create falla por FK violation.

## Scope

### Include
- `src/app/api/prompts/[id]/publish/route.ts`

### Exclude
- No modificar l贸gica de publicaci贸n
- No cambiar otros endpoints

## Dependencies
Ninguna

## Acceptance Criteria
- [ ] POST /api/prompts/[id]/publish retorna 500 con mensaje claro si no hay reviewer disponible
- [ ] No se crea auditLog con userId null
- [ ] Prompt no se publica si no se puede auditar

## Definition of Done

### Tests
- [ ] Test manual: eliminar users, intentar publicar, verificar error

### Security
- [ ] No se crean registros hu茅rfanos en auditLog

### Observability
- [ ] console.error con contexto cuando no hay reviewer

### Docs
- N/A

### Evidence
- [ ] curl command mostrando error 500 con mensaje
- [ ] Diff del cambio

## Verify

### Commands
```bash
# Publicar prompt (debe funcionar si hay users)
curl -X POST http://localhost:3000/api/prompts/<ID>/publish

# Lint
bun run lint
```

### Expected
- Si no hay users: retorna 500 con `{error: 'No hay usuario disponible para auditar'}`
- Si hay users: retorna 200 con prompt publicado

## Risk

### Failure Modes
- Bloquear publicaci贸n leg铆tima si check es muy restrictivo

### Rollback
```bash
git revert <commit-hash>
```

## Notes
- Considerar crear usuario sistema 'system' para auditor铆as automatizadas
- El archivo actual obtiene reviewer con `db.user.findFirst()` que puede retornar null

## Implementaci贸n Sugerida

```typescript
// Obtener usuario por defecto si no se proporciona
let reviewer = reviewerId;
if (!reviewer) {
  const defaultUser = await db.user.findFirst();
  if (defaultUser) {
    reviewer = defaultUser.id;
  }
}

// AGREGAR VALIDACIN:
if (!reviewer) {
  return NextResponse.json(
    { error: 'No hay usuario disponible para auditar la publicaci贸n' },
    { status: 500 }
  );
}

// Continuar con la publicaci贸n...
```

## Log de Cambios
| Fecha | Estado | Notas |
|-------|--------|-------|
| - |  Pending | Creado |
