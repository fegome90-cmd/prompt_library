# WO-0002: Envolver contadores en transacci贸n at贸mica

## Metadatos
| Campo | Valor |
|-------|-------|
| id | WO-0002 |
| title | Envolver contadores en transacci贸n at贸mica |
| type | fix |
| priority | P0 |
| area | DB |
| status |  Pending |

## Rationale
Hallazgo HIGH: Race condition en contadores useCount, thumbsUp, thumbsDown. Incrementos sin transacci贸n pueden perder datos bajo concurrencia.

## Scope

### Include
- `src/app/api/prompts/[id]/feedback/route.ts`

### Exclude
- No modificar endpoint GET
- No cambiar l贸gica de feedback

## Dependencies
Ninguna

## Acceptance Criteria
- [ ] Incremento de useCount y thumbsUp/thumbsDown ocurren en una 煤nica transacci贸n
- [ ] Si auditLog falla, el incremento se revierte
- [ ] Concurrent requests no pierden incrementos

## Definition of Done

### Tests
- [ ] Test manual: 10 requests concurrentes resultan en +10 useCount

### Security
- N/A

### Observability
- [ ] console.error con contexto si transacci贸n falla

### Docs
- N/A

### Evidence
- [ ] Script de prueba concurrente (bash o curl paralelo)
- [ ] Diff del cambio
- [ ] Screenshot de useCount correcto despu茅s de prueba

## Verify

### Commands
```bash
# Test concurrencia - 10 requests paralelos
for i in {1..10}; do curl -X POST -H "Content-Type: application/json" -d '{"feedback":"thumbs_up"}' http://localhost:3000/api/prompts/<ID>/feedback & done; wait

# Verificar contadores
curl http://localhost:3000/api/prompts/<ID> | jq '.useCount, .thumbsUp'
```

### Expected
- useCount increment贸 exactamente 10
- thumbsUp increment贸 exactamente 10

## Risk

### Failure Modes
- Deadlock si transacci贸n toma demasiado tiempo
- SQLite tiene limitaciones de concurrencia

### Rollback
```bash
git revert <commit-hash>
```

## Notes
- SQLite tiene un solo writer a la vez, pero transacciones garantizan atomicidad
- Usar `db.$transaction([...])` de Prisma

## Implementaci贸n Sugerida

```typescript
// Antes (problem谩tico):
await db.promptUsage.create({ ... });
await db.prompt.update({
  where: { id },
  data: { useCount: { increment: 1 }, thumbsUp: { increment: 1 } }
});
await db.auditLog.create({ ... });

// Despu茅s (at贸mico):
await db.$transaction([
  db.promptUsage.create({ ... }),
  db.prompt.update({
    where: { id },
    data: { useCount: { increment: 1 }, thumbsUp: { increment: 1 } }
  }),
  db.auditLog.create({ ... })
]);
```

## Log de Cambios
| Fecha | Estado | Notas |
|-------|--------|-------|
| - |  Pending | Creado |
